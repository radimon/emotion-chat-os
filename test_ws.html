<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8" />
        <title>WS Test</title>
        <style>
            body { font-family: sans-serif; padding: 16px;}
            pre { background: #f5f5f5; padding: 12px; border-radius: 8px;}
        </style>
    </head>
    <body>
        <h3>WebSocket Test</h3>
        <button id="sendBtn"> Send message</button>
        <pre id="log"></pre>
        <script>
            const logEl  = document.getElementById("log");
            let buffer = "";

            function log(msg){
                logEl.textContent += msg + "\n";
            }

            const ws = new WebSocket("ws://127.0.0.1:8000/ws/chat");

            ws.onopen = () => log("OPEN");

            ws.onmessage = (e) => {
                const data = JSON.parse(e.data);

                if(data.type === "ack"){
                    log("ACK received");
                }

                if(data.type === "stream"){
                    buffer += data.delta;
                    logEl.textContent = buffer;
                }

                if(data.type === "done"){
                    log("\n[DONE]");
                }
            };

            ws.onerror = (e) => log("ERROR");
            ws.onclose = (e) => log(`CLOSE: code=${e.code}`);

            document.getElementById("sendBtn").onclick = () => {
                buffer = "";
                ws.send(JSON.stringify({
                    user_id: "u1",
                    message: "我真的好累"
                }));
            };
        </script>
    </body>
</html>